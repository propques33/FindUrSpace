<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads | FindUrSpace</title>
    <link rel="icon" href="{{ url_for('static', filename='images/Asset 6.png') }}" type="image/x-icon">

    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Report School Regular', Arial, sans-serif;
            background-color: #f9f9f9;
        }

        .content-wrapper {
            padding: 20px;
            margin-top: 56px;
            transition: margin-left 0.3s;
        }

        .leads-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .leads-container h2 {
            font-weight: 700;
            color: #0C1427;
            margin-bottom: 20px;
        }
        .filter-container{
            display: flex;
            flex-direction: column;
            row-gap: 10px;
        }
        .filter-container .btn-group{
            display:flex;
            flex-direction: row;
            column-gap: 20px;
            margin-top:15px;
            margin-bottom:15px;
        }

        .table-container {
            overflow-x: auto;
        }

        /* Hide scrollbar */
        .table-container::-webkit-scrollbar {
            display: none;
        }

        .table-container {
            scrollbar-width: none; /* For Firefox */
        }

        .leads-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leads-table th,
        .leads-table td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid #ddd;
            white-space: nowrap;
        }

        .leads-table th {
            color: rgb(0, 0, 0);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .leads-table td {
            font-size: 0.9rem;
        }

        /* Responsive padding for mobile */
        @media (max-width: 767px) {
            .content-wrapper {
                padding: 10px;
            }

            .leads-table th,
            .leads-table td {
                padding: 10px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>
    {% include 'operators_navigation.html' %} <!-- Include the operators' sidebar -->

    <!-- Main content section -->
    <div id="page-content-wrapper" class="content-wrapper">
        <div class="container-fluid">
            <div class="leads-container">
                <h2>Leads</h2>
                <p>Here are the leads generated by us for you!</p>
                <!-- City and Micromarket Filter Dropdowns -->
                <form method="get" action="{{ url_for('operators.leads') }}" class="filter-form">
                    {% if role == 'owner' %}
                    <div class="filter-container">
                    <!-- City Filter -->
                    <div class="form-group">
                        <label for="city-filter" class="form-label">Filter by City:</label>
                        <select name="city" id="city-filter" class="form-select" onchange="updateMicromarkets()">
                            <option value="All" {% if not selected_city or selected_city == 'All' %}selected{% endif %}>All Cities</option>
                            {% for city in cities %}
                            <option value="{{ city }}" {% if selected_city == city %}selected{% endif %}>{{ city }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Micromarket Filter -->
                    <div class="form-group" id="micromarket-container" {% if not selected_city or selected_city == 'All' %}style="display: none;"{% endif %}>
                        <label for="micromarket-filter" class="form-label">Filter by Micromarket:</label>
                        <select name="micromarket" id="micromarket-filter" class="form-select">
                            <option value="All" {% if not selected_micromarket or selected_micromarket == 'All' %}selected{% endif %}>All Micromarkets</option>
                            {% for micromarket in micromarkets %}
                            <option value="{{ micromarket }}" {% if selected_micromarket == micromarket %}selected{% endif %}>{{ micromarket }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Buttons -->
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary rounded-5 py-2 ">Apply Filters</button>
                        <a href="{{ url_for('operators.leads') }}" class="btn btn-secondary rounded-5 py-2 ">Reset Filters</a>
                    </div>
                </div>
                {% endif %}
                </form>

                <div class="table-container">
                    <table class="table table-bordered table-hover leads-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User Name</th>
                                <th>Company</th>
                                <th>Email</th>
                                <th>Contact</th>
                                <th>City</th>
                                <th>Micromarket</th>
                                <th>Seats</th>
                                <th>Budget</th>
                                <th>Opportunity Status</th>
                                <th>Opportunity Stage</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lead in leads %}
                            <tr>
                                <td>{{ lead.date.strftime('%d %b %Y') }}</td>
                                <td>{{ lead.user_name }}</td>
                                <td>{{ lead.user_company }}</td>
                                <td>{{ lead.user_email }}</td>
                                <td>{{ lead.user_contact }}</td>
                                <td>{{ lead.city }}</td>
                                <td>{{ lead.micromarket }}</td>
                                <td>{{ lead.property_seats }}</td>
                                <td>{{ lead.property_budget }}</td>
                                <td>
                                    <select class="form-select form-select-sm" onchange="updateLead('{{ lead.lead_id }}', '{{ lead.property_id }}', 'opportunity_status', this.value)">
                                        <option value="open" {% if lead.opportunity_status == 'open' %}selected{% endif %}>Open</option>
                                        <option value="closed" {% if lead.opportunity_status == 'closed' %}selected{% endif %}>Closed</option>
                                        <option value="won" {% if lead.opportunity_status == 'won' %}selected{% endif %}>Won</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="form-select form-select-sm" onchange="updateLead('{{ lead.lead_id }}', '{{ lead.property_id }}', 'opportunity_stage', this.value)">
                                        <option value="visit done" {% if lead.opportunity_stage == 'visit done' %}selected{% endif %}>Visit Done</option>
                                        <option value="qualified" {% if lead.opportunity_stage == 'qualified' %}selected{% endif %}>Qualified</option>
                                        <option value="follow-up" {% if lead.opportunity_stage == 'follow-up' %}selected{% endif %}>Follow-Up</option>
                                        <option value="negotiation" {% if lead.opportunity_stage == 'negotiation' %}selected{% endif %}>Negotiation</option>
                                        <option value="won" {% if lead.opportunity_stage == 'won' %}selected{% endif %}>Won</option>
                                        <option value="lost" {% if lead.opportunity_stage == 'lost' %}selected{% endif %}>Lost</option>
                                        <option value="unqualified" {% if lead.opportunity_stage == 'unqualified' %}selected{% endif %}>Unqualified</option>
                                    </select>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function updateMicromarkets() {
    const city = document.getElementById('city-filter').value;
    const micromarketContainer = document.getElementById('micromarket-container');
    const micromarketFilter = document.getElementById('micromarket-filter');

    micromarketFilter.innerHTML = '<option value="All">All Micromarkets</option>'; // Reset options

    if (city !== 'All') {
        fetch(`/operators/get_micromarkets?city=${encodeURIComponent(city)}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    micromarketContainer.style.display = 'block';
                    data.micromarkets.forEach(micromarket => {
                        const option = document.createElement('option');
                        option.value = micromarket;
                        option.textContent = micromarket;
                        micromarketFilter.appendChild(option);
                    });
                } else {
                    micromarketContainer.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error fetching micromarkets:', error);
                micromarketContainer.style.display = 'none';
            });
    } else {
        micromarketContainer.style.display = 'none';
    }
}
    
        function updateLead(leadId, propertyId, field, value) {
            let data = {
                lead_id: leadId,
                property_id: propertyId
            };
            data[field] = value;
    
            fetch('/operators/update_lead_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update lead status');
                }
                return response.json();
            })
            .then(data => {
                if (data.status !== 'success') {
                    alert('Failed to update lead status: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating lead status');
            });
        }
    </script>
    
    
</body>

</html>
