<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags and Title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta description="List your property effortlessly on Findurspace. Reach potential tenants quickly with our easy-to-use platform for commercial and residential spaces.">
    <link rel="canonical" href="https://findurspace.tech/list-your-space" />
    <title>List Your Coworking Space - FindUrSpace</title>
    <link rel="icon" href="../static/images/Asset 6.png" type="image/x-icon">

    <!-- Schema Markup for Organization -->
    <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "name": "FindUrSpace",
      "url": "https://findurspace.tech",
      "logo": "https://findurspace.tech/static/images/logo.png",
      "contactPoint": [{
        "@type": "ContactPoint",
        "contactType": "Customer Service",
        "url": "https://findurspace.tech/contact",
        "areaServed": "India"
      }]
    }
    </script>

    <!-- Parsley CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/parsleyjs/src/parsley.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Optional: Include your own CSS for additional styling -->
    <style>
    /* General Body Styling */
    body {
        background-color: #ffffff; /* Light background */
        color: #333; /* Darker text for readability */
    }

    .container {
        max-width: 800px;
        margin-top: 40px;
        margin-bottom: 40px;
    }

    .card {
        margin-bottom: 20px;
    }

    .btn-close{
        color:black;
        position:absolute;
        top:0;
        right:0;
    }
    /* Centered Button */
    .centered-button {
        display: block; /* Center the button */
        margin: 0 auto;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 16px;
        background-color: #28a745; /* Green background */
        color: white;
        border: 2px solid #28a745;
        width: auto;
        text-align: center;
        cursor: pointer;
    }

    .centered-button:hover {
        background-color: #218838; /* Darker green on hover */
        border-color: #218838;
    }

    /* Delete Button */
    .delete-button {
        background: none;
        border: none;
        color: white;
        background-color:red;
        padding:5px 14px;
        border-radius: 1000px;
        font-size: 24px;
        margin-right: 10px;
        cursor: pointer;
        border:2px solid white;
    }

    .delete-button:hover {
        color: red;
        background-color: white;
        border:2px solid red;
    }

    /* Image Preview Styles */
    .preview-img-container {
        position: relative;
        display: inline-block;
        margin-right: 10px;
        margin-bottom: 10px;
    }

    .preview-img {
        max-width: 100px;
        cursor: pointer;
        border: 2px solid #ddd;
        border-radius: 5px;
    }

    .preview-img-container .delete-button {
        position: absolute;
        top: -10px;
        right: -10px;
        background-color: red;
        color: white;
        border: 1px solid red;
        font-size: 20px;
        border-radius: 50%;
        padding: 0 10px;
        cursor: pointer;
    }

    
    /* General Input Styling */
    input, select, textarea {
        border: 2px solid #ccc; /* Default neutral border color */
        background-color: #f8f9fa; /* Light gray background */
        transition: background-color 0.3s ease, border-color 0.3s ease; /* Smooth transition */
    }

    /* Input Validation Styling */
    input.parsley-error,
    select.parsley-error,
    textarea.parsley-error {
        border: 2px solid #dc3545; /* Use Bootstrap's danger color */
        background-color: #fff1f2; /* Light red background */
        position: relative;
    }

    /* Placeholder as Error Message Inside Input Field */
    input.parsley-error::placeholder,
    select.parsley-error::placeholder,
    textarea.parsley-error::placeholder {
        color: #dc3545; /* Red placeholder for error message */
        opacity: 1; /* Ensure full visibility of the error message */
    }

    /* On hover, change input border color */
    input.parsley-error:hover,
    select.parsley-error:hover,
    textarea.parsley-error:hover {
        border-color: #e63946; /* Slightly darker red on hover */
    }

    /* Success Input Fields */
    input.parsley-success,
    select.parsley-success,
    textarea.parsley-success {
        border: 2px solid #ccc; 
        background-color: #f8f9fa; /* Light green background */
    }

    /* Error Message Styling */
    .parsley-errors-list {
        margin-top: 5px; /* Space between input and error message */
        color: #dc3545; /* Bootstrap's danger color */
        font-size: 0.875rem; /* Slightly smaller font size */
        font-weight: bold;
        list-style-type: none; /* No bullet points */
        padding-left: 0; /* No padding */
        position: relative; /* Ensure it stays relative to input */
        display: block; /* Force the error message to appear below */
        width: 100%; /* Make sure it takes up full width below the input */
        min-height: 1.2em; /* Reserve space for error messages */
    }

    /* Form Fields Two per Row */
    .form-group {
        display: flex;
        gap: 15px;
        align-items: flex-start; /* Align inputs and error messages */
    }

    .form-group .form-control {
        flex: 1;
    }

    /* Inventory Item Layout */
    .inventory-item .form-select,
    .inventory-item .form-control {
        flex: 1;
    }

    .inventory-item .form-group {
        align-items: flex-start;
    }

    .inventory-item {
        border-top: 1px solid #ddd;
        padding-top: 15px;
        margin-top: 15px;
    }

    /* For Small Screens, Stack Fields Vertically */
    @media (max-width: 576px) {
        .form-group {
            flex-direction: column;
        }
    }

    /* File Format Note */
    .file-format-note {
        font-size: 0.875rem;
        color: #6c757d;
    }

    /* Loading Spinner Styles */
    #loadingSpinner {
        display: none;
        text-align: center;
        margin: 20px 0;
    }

    /* Flash Messages Styling */
    .flash-message {
        padding: 10px 20px;
        border-radius: 5px;
    }

    .flash-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .flash-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    </style>
</head>
<body>

<div class="container">

    <!-- Flash Messages (Success/Error) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-4">
            {% for category, message in messages %}
              <div class="flash-message flash-{{ 'success' if category == 'success' else 'error' }}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
    {% endwith %}

    <h1 class="text-center mb-4">{{ 'Edit Your Space' if space else 'List Your Space' }}</h1>

            <!-- "Where did you hear from us?" Section -->
            <div class="card">
                <div class="card-header">
                    How Did You Hear About Us?
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <div class="mb-3 w-100">
                            <label for="hear_from" class="form-label">Where did you hear from us?</label>
                            <select class="form-select" id="hear_from" name="hear_from" required
                                data-parsley-required-message="Please select an option." data-parsley-trigger="change" aria-label="Where did you hear from us?">
                                <option value="" disabled {{ 'selected' if not space or not space.get('hear_from') else '' }}>Select an option</option>
                                <option value="Email campaigns" {{ 'selected' if space and space.get('hear_from') == 'Email campaigns' else '' }}>Email campaigns</option>
                                <option value="WhatsApp campaigns" {{ 'selected' if space and space.get('hear_from') == 'WhatsApp campaigns' else '' }}>WhatsApp campaigns</option>
                                <option value="Facebook" {{ 'selected' if space and space.get('hear_from') == 'Facebook' else '' }}>Facebook</option>
                                <option value="Instagram" {{ 'selected' if space and space.get('hear_from') == 'Instagram' else '' }}>Instagram</option>
                                <option value="Calls" {{ 'selected' if space and space.get('hear_from') == 'Calls' else '' }}>Calls</option>
                                <option value="Other" {{ 'selected' if space and space.get('hear_from') == 'Other' else '' }}>Other</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

    <!-- Form: Owner Information and Coworking Space Details -->
    <form id="listSpaceForm" action="{{ url_for('core_bp.list_your_space') if not space else url_for('operators.edit_space', space_id=space['_id']) }}" method="post" enctype="multipart/form-data" data-parsley-validate>
        {% if context != 'add_space' %}
            {% if role == 'center_manager' %}
            <div class="card">
                <div class="card-header">
                    Stage 1: Owner Information
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <div class="mb-3 w-100">
                            <input type="text" class="form-control" id="coworking_name" name="coworking_name" placeholder="Coworking Name" required
                                value="{{ space['coworking_name'] if space else '' }}"
                                readonly>
                        </div>
                        <div class="mb-3 w-100">
                            <input type="text" class="form-control" id="name" name="name" placeholder="Your Name" required
                                value="{{ space['owner']['name'] if space else '' }}"
                                readonly>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <div class="mb-3 w-100">
                            <input type="tel" class="form-control" id="owner_phone" name="owner_phone" placeholder="Owner Phone Number" required
                                value="{{ space['owner']['phone'] if space else '' }}"
                                readonly>
                        </div>
                        <div class="mb-3 w-100">
                            <input type="email" class="form-control" id="owner_email" name="owner_email" placeholder="Owner Email Address" required
                                value="{{ space['owner']['email'] if space else '' }}"
                                readonly>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card">
                <div class="card-header">
                    Stage 1: Owner Information
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <div class="mb-3 w-100">
                            <input type="text" class="form-control" id="coworking_name" name="coworking_name" placeholder="Coworking Name" required
                                value="{{ space['coworking_name'] if space else '' }}"
                                data-parsley-required-message="Please enter the coworking space name." data-parsley-trigger="change" aria-label="Coworking Name">
                        </div>
                        <div class="mb-3 w-100">
                            <input type="text" class="form-control" id="name" name="name" placeholder="Your Name" required
                                value="{{ space['owner']['name'] if space else '' }}"
                                data-parsley-required-message="Please enter your name." data-parsley-trigger="change" aria-label="Your Name">
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <div class="mb-3 w-100">
                            <input type="tel" class="form-control" id="owner_phone" name="owner_phone" placeholder="Owner Phone Number" required
                                value="{{ space['owner']['phone'] if space else '' }}"
                                data-parsley-required-message="Please enter your phone number."
                                data-parsley-pattern="^[0-9]{10}$"
                                data-parsley-pattern-message="Please enter a valid 10-digit phone number."
                                data-parsley-trigger="change" aria-label="Owner Phone Number">
                        </div>
                        <div class="mb-3 w-100">
                            <input type="email" class="form-control" id="owner_email" name="owner_email" placeholder="Owner Email Address" required
                                value="{{ space['owner']['email'] if space else '' }}"
                                data-parsley-required-message="Please enter your email address."
                                data-parsley-type="email"
                                data-parsley-type-message="Please enter a valid email address."
                                data-parsley-trigger="change" aria-label="Owner Email Address">
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% else %}
        <!-- Hidden Owner Information for Add Space -->
        <input type="hidden" name="name" value="{{ owner_details['name'] }}">
        <input type="hidden" name="owner_phone" value="{{ owner_details['phone'] }}">
        <input type="hidden" name="owner_email" value="{{ owner_details['email'] }}">
        <div class="mb-3 w-100">
            <input type="text" class="form-control" id="coworking_name" name="coworking_name" placeholder="Coworking Name" readonly
                value="{{ coworking_name }}"
                aria-label="Coworking Name">
        </div>
        {% endif %}

        <!-- Stage 2: Coworking Space Details -->
        <div id="spaceDetailsContainer">
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    {% if space %}
                        // Edit mode: Pre-fill with existing data
                        addSpaceDetails({{ space | tojson | safe }});
                    {% else %}
                        // Add/Normal mode: Initialize with one empty section
                        addSpaceDetails();
                    {% endif %}
                });
            </script>
        </div>

        <!-- Button to add more coworking spaces (Hide when editing) -->
        {% if not space %}
        <button type="button" class="btn btn-primary mb-3" onclick="addSpaceDetails()"> Add Coworking Space</button>
        {% endif %}

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center my-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Submitting your information...</p>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn centered-button" id="submitButton">{{ 'Update Space' if space else 'Submit' }}</button>

    </form>
</div>

<!-- jQuery (Required for Parsley.js if using older versions; optional for newer setups) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Parsley JS -->
<script src="https://cdn.jsdelivr.net/npm/parsleyjs"></script>

<!-- Bootstrap JS (for components like modals, if needed) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript to handle dynamic form sections and Parsley validation -->
<script>
    let spaceCount = 0;

    // Function to add a coworking space section
    function addSpaceDetails(spaceData = null) {
            // Prevent multiple sections in edit mode
        if (spaceData && spaceCount > 0) {
            return;
        }
        spaceCount++;

        const spaceDetailsContainer = document.getElementById('spaceDetailsContainer');

        const spaceCard = document.createElement('div');
        spaceCard.classList.add('card');

        // Pre-fill values if spaceData is provided
        const city = spaceData ? spaceData['city'] || '' : '';
        const micromarket = spaceData ? spaceData['micromarket'] || '' : '';
        const total_seats = spaceData ? spaceData['total_seats'] || '' : '';
        const current_vacancy = spaceData ? spaceData['current_vacancy'] || '' : '';
        const center_manager_name = spaceData ? spaceData['center_manager_name'] || '' : '';
        const center_manager_contact = spaceData ? spaceData['center_manager_contact'] || '' : '';

        const inventoryList = spaceData ? spaceData['inventory'] || [] : [];

        spaceCard.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Stage 2: Coworking Space Details (${spaceCount})</span>
                ${spaceData ? '' : '<button type="button" class="delete-button" onclick="removeSpaceDetails(this)" title="Remove this coworking space">&times;</button>'}
            </div>
            <div class="card-body">
                <!-- Hidden input to keep track of space indices -->
                <input type="hidden" name="space_indices[]" value="${spaceCount}">

                <!-- City and Micromarket -->
                <div class="form-group mb-3">
                    <div class="mb-3 w-100">
                        <select id="location_${spaceCount}" class="form-control" name="city[]" placeholder="City" value="${city}"
                        data-parsley-required-message="Please enter the city." data-parsley-trigger="change" aria-label="City" required onchange="fetchMicromarkets()">
                            <option value="" disabled ${city ? '' : 'selected'}>Select Location *</option>
                        </select>
                    </div>
                    <div class="mb-3 w-100">
                        <select id="micromarket_${spaceCount}" class="form-control" name="micromarket[]" placeholder="Micromarket" required
                            value="${micromarket}"
                            data-parsley-required-message="Please enter the micromarket." data-parsley-trigger="change" aria-label="Micromarket>
                            <option value="" disabled ${micromarket ? '' : 'selected'}>Select Micromarket *</option>
                        </select>
                    </div>
                </div>
                <!-- Center Manager Details -->
                <h5>Center Manager Details</h5>
                <div class="form-group mb-3">
                    <div class="mb-3 w-100">
                        <input type="text" class="form-control" name="center_manager_name[]" placeholder="Center Manager Name" required
                            value="${center_manager_name}"
                            data-parsley-required-message="Please enter the center manager name."
                            data-parsley-trigger="change" aria-label="Center Manager Name">
                    </div>
                    <div class="mb-3 w-100">
                        <input type="tel" class="form-control" name="center_manager_contact[]" placeholder="Center Manager Contact" required
                            value="${center_manager_contact}"
                            data-parsley-required-message="Please enter the center manager contact."
                            data-parsley-pattern="^[0-9]{10}$"
                            data-parsley-pattern-message="Please enter a valid 10-digit phone number."
                            data-parsley-trigger="change" aria-label="Center Manager Contact">
                    </div>
                </div>
                <!-- About Space -->
                <h5>About Space</h5>
                <div class="form-group mb-3">
                    <div class="mb-3 w-100">
                        <input type="number" class="form-control" name="total_seats[]" placeholder="Total Seats" min="0" required
                            value="${total_seats}"
                            data-parsley-required-message="Please enter the total number of seats."
                            data-parsley-type="number"
                            data-parsley-trigger="change" aria-label="Total Seats" onchange="updateCurrentVacancy(${spaceCount})">
                    </div>
                    <div class="mb-3 w-100">
                        <input type="number" class="form-control" name="current_vacancy[]" placeholder="This value is automatically calculated" min="0" readonly
                            value="0" id="current_vacancy_${spaceCount}" aria-label="Current Vacancy">
                        <small class="text-muted">This value will be automatically calculated based on the inventory.</small>
                        <div id="vacancyError_${spaceCount}" class="text-danger mt-1"></div>
                    </div>
                </div>

                <!-- Inventory Breakup -->
                <h5>Inventory Breakup</h5>
                <div id="inventoryContainer_${spaceCount}">
                    <!-- Inventory items will be added here -->
                </div>
                <button type="button" class="btn btn-secondary mb-3" onclick="addInventory(${spaceCount})">+ Add Inventory</button>

                <!-- Upload Layouts or Images -->
                <h5>Upload Layouts or Images</h5>
                <p class="file-format-note">Only JPG, JPEG, and PNG files are allowed. You can upload multiple images.</p>
                <div class="mb-3">
                    <input type="file" class="form-control" name="layout_images_${spaceCount}[]" accept="image/png, image/jpeg, image/jpg" multiple onchange="previewImages(event, ${spaceCount})" ${spaceData ? '' : 'required'}
                        data-parsley-required-message="Please upload at least one image." data-parsley-trigger="change" aria-label="Upload Layouts or Images">
                </div>
                <div id="imagePreview_${spaceCount}" class="d-flex flex-wrap">
                    <!-- Image previews will be displayed here -->
                </div>
            </div>
        `;
        spaceDetailsContainer.appendChild(spaceCard);
        // Populate the location dropdown
        populateLocationsDropdown(spaceCount, city, micromarket);

        // Initialize the inventory section
        if (inventoryList.length > 0) {
            inventoryList.forEach((inventoryItem) => {
                addInventory(spaceCount, inventoryItem);
            });
        } else {
            addInventory(spaceCount);
        }

        // Display existing images if any
        if (spaceData && spaceData['layout_images'] && spaceData['layout_images'].length > 0) {
            const imagePreviewContainer = document.getElementById(`imagePreview_${spaceCount}`);
            spaceData['layout_images'].forEach((imageUrl, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add('preview-img-container');
                imgContainer.innerHTML = `
                    <img src="${imageUrl}" class="preview-img" data-bs-toggle="modal" data-bs-target="#existingImageModal_${spaceCount}_${index}" alt="Image Preview">
                    <button type="button" class="delete-button" onclick="removeExistingImage(${spaceCount}, ${index})" title="Remove this image">&times;</button>
                `;

                // Append the image container to the preview
                imagePreviewContainer.appendChild(imgContainer);

                // Create the modal for magnification
                const modal = document.createElement('div');
                modal.classList.add('modal', 'fade');
                modal.id = `existingImageModal_${spaceCount}_${index}`;
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-labelledby', `existingImageModalLabel_${spaceCount}_${index}`);
                modal.setAttribute('aria-hidden', 'true');
                modal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="existingImageModalLabel_${spaceCount}_${index}">Image Preview</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <img src="${imageUrl}" class="img-fluid" alt="Full Image">
                            </div>
                        </div>
                    </div>
                `;

                // Append the modal to the body
                document.body.appendChild(modal);
            });
        }

        // Refresh Parsley to recognize new fields
        $('#listSpaceForm').parsley().refresh();
    }

    // Function to fetch and populate locations in the dropdown
// function populateLocationsDropdown(spaceId, selectedCity = '', selectedMicromarket = '') {
//     const locationDropdown = document.getElementById(`location_${spaceId}`);

//     fetch('/get_locations', { method: 'GET' })
//         .then(response => response.json())
//         .then(data => {
//             const locations = data.locations || [];
//             locations.forEach(location => {
//                 const option = document.createElement('option');
//                 option.value = location;
//                 option.textContent = location;
//                 if (location === selectedCity) {
//                     option.selected = true;
//                 }
//                 locationDropdown.appendChild(option);
//             });

//             // Trigger micromarket population if city is preselected
//             if (selectedCity) {
//                 populateMicromarketDropdown(spaceId, selectedCity, selectedMicromarket);
//             }

//             locationDropdown.addEventListener('change', function () {
//                 const selectedCity = locationDropdown.value;
//                 populateMicromarketDropdown(spaceId, selectedCity);
//             });
//         })
//         .catch(error => console.error('Error fetching locations:', error));
// }

// Populate locations dropdown
function populateLocationsDropdown(spaceId, selectedCity = '', selectedMicromarket = '') {
    const locationDropdown = document.getElementById(`location_${spaceId}`);
    fetch('/get_locations')
        .then(response => response.json())
        .then(data => {
            const locations = data.locations || [];
            // Sort locations alphabetically and add "Other" as the last option
            const sortedLocations = [...locations.sort((a, b) => a.localeCompare(b)), "Other"];
            locationDropdown.innerHTML = '<option value="" disabled selected>Select Location *</option>';

            sortedLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                if (location === selectedCity) {
                    option.selected = true;
                }
                locationDropdown.appendChild(option);
            });


            locationDropdown.addEventListener('change', function () {
                if (locationDropdown.value === "Other") {
                    showCustomInput('location', spaceId);
                    // Set micromarket dropdown to only have "Other"
                    populateMicromarketDropdown(spaceId, "Other");
                } else {
                    hideCustomInput('location', spaceId);
                    populateMicromarketDropdown(spaceId, locationDropdown.value);
                }
            });

            if (selectedCity) {
                populateMicromarketDropdown(spaceId, selectedCity, selectedMicromarket);
            }
        })
        .catch(error => console.error('Error fetching locations:', error));
}

// Function to fetch and populate micromarkets for a selected location
// function populateMicromarketDropdown(spaceId, selectedCity, selectedMicromarket = '') {
//     const micromarketDropdown = document.getElementById(`micromarket_${spaceId}`);
//     micromarketDropdown.innerHTML = '<option value="" disabled selected>Select Micromarket</option>';
//     micromarketDropdown.disabled = true;

//     fetch(`/get_micromarkets?city=${selectedCity}`, { method: 'GET' })
//         .then(response => response.json())
//         .then(data => {
//             const micromarkets = data.micromarkets || [];
//             micromarkets.forEach(micromarket => {
//                 const option = document.createElement('option');
//                 option.value = micromarket;
//                 option.textContent = micromarket;
//                 if (micromarket === selectedMicromarket) {
//                     option.selected = true;
//                 }
//                 micromarketDropdown.appendChild(option);
//             });

//             micromarketDropdown.disabled = false;
//         })
//         .catch(error => console.error('Error fetching micromarkets:', error));
// }

// Populate micromarkets dropdown
function populateMicromarketDropdown(spaceId, selectedCity, selectedMicromarket = '') {
    const micromarketDropdown = document.getElementById(`micromarket_${spaceId}`);
    micromarketDropdown.innerHTML = '<option value="" disabled selected>Select Micromarket *</option>';

    if (selectedCity === "Other") {
        // Directly add the "Other" option when city is "Other"
        micromarketDropdown.innerHTML += `
            <option value="Other">Other</option>
        `;
        micromarketDropdown.disabled = false;

        // Handle "Other" selection
        micromarketDropdown.addEventListener('change', function () {
            if (micromarketDropdown.value === "Other") {
                showCustomInput('micromarket', spaceId);
            } else {
                hideCustomInput('micromarket', spaceId);
            }
        });
        return; 
    }

    fetch(`/get_micromarkets?city=${selectedCity}`)
        .then(response => response.json())
        .then(data => {
            const micromarkets = data.micromarkets || [];
            // Sort micromarkets alphabetically and add "Other" as the last option
            const sortedMicromarkets = [...micromarkets.sort((a, b) => a.localeCompare(b)), "Other"];

            sortedMicromarkets.forEach(micromarket => {
                const option = document.createElement('option');
                option.value = micromarket;
                option.textContent = micromarket;

                // If a micromarket was already selected, pre-select it
                if (micromarket === selectedMicromarket) {
                    option.selected = true;
                }
                micromarketDropdown.appendChild(option);
            });


            micromarketDropdown.disabled = false;

            micromarketDropdown.addEventListener('change', function () {
                if (micromarketDropdown.value === "Other") {
                    showCustomInput('micromarket', spaceId);
                } else {
                    hideCustomInput('micromarket', spaceId);
                }
            });
        })
        .catch(error => console.error('Error fetching micromarkets:', error));
}

    // Function to add an inventory item
    function addInventory(spaceId, inventoryData = null) {
        const inventoryContainer = document.getElementById(`inventoryContainer_${spaceId}`);

        const inventoryCount = inventoryContainer.childElementCount + 1;

        // Pre-fill values if inventoryData is provided
        const inventoryType = inventoryData ? inventoryData['type'] || '' : '';
        const inventoryCountValue = inventoryData ? inventoryData['count'] || '' : '';
        const pricePerSeat = inventoryData ? inventoryData['price_per_seat'] || '' : '';

        const inventoryRow = document.createElement('div');
        inventoryRow.classList.add('border', 'p-3', 'mb-3', 'position-relative', 'inventory-item');
        inventoryRow.innerHTML = `
            <h6>Inventory ${inventoryCount}</h6>

            <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close" onclick="removeInventory(this)" title="Remove this inventory item"></button>
            <div class="form-group mb-3">
                <div class="mb-3 w-100">
                    <select class="form-select" name="inventory_type_${spaceId}[]" required
                        data-parsley-required-message="Please select an inventory type." data-parsley-trigger="change" aria-label="Inventory Type" onchange="handlePriceChange(this, ${spaceId}, ${inventoryCount})">
                        <option value="" disabled ${!inventoryType ? 'selected' : ''}>Inventory Type</option>
                        <option value="Conference rooms" ${inventoryType === 'Conference rooms' ? 'selected' : ''}>Conference rooms</option>
                        <option value="Coworking space" ${inventoryType === 'Coworking space' ? 'selected' : ''}>Coworking space</option>
                        <option value="Day pass" ${inventoryType === 'Day pass' ? 'selected' : ''}>Day pass</option>
                        <option value="Dedicated desk" ${inventoryType === 'Dedicated desk' ? 'selected' : ''}>Dedicated desk</option>
                        <option value="Meeting rooms" ${inventoryType === 'Meeting rooms' ? 'selected' : ''}>Meeting rooms</option>
                        <option value="Private cabin" ${inventoryType === 'Private cabin' ? 'selected' : ''}>Private cabin</option>
                        <option value="Serviced offices" ${inventoryType === 'Serviced offices' ? 'selected' : ''}>Serviced offices</option>
                        <option value="Virtual office" ${inventoryType === 'Virtual office' ? 'selected' : ''}>Virtual office</option>
                    </select>
                </div>
                <div class="mb-3 w-100">
                    <input type="number" class="form-control" id="priceInput_${spaceId}_${inventoryCount}" name="price_per_seat_${spaceId}[]" placeholder="Price per Seat" min="0" required
                        value="${pricePerSeat}"
                        data-parsley-required-message="Please enter the price per seat."
                        data-parsley-type="number"
                        data-parsley-trigger="change" aria-label="Price per Seat">
                </div>
            </div>
            <div class="form-group mb-3">
                <div class="mb-3 w-100">
                    <input type="number" class="form-control" name="inventory_count_${spaceId}[]" placeholder="Number of Vacant Inventory" min="0" required
                        value="${inventoryCountValue}"
                        onchange="updateCurrentVacancy(${spaceId})"
                        data-parsley-required-message="Please enter the number of vacant inventory."
                        data-parsley-type="number"
                        data-parsley-trigger="change" aria-label="Number of Vacant Inventory">
                </div>
                <!-- Placeholder div to maintain two per row layout -->
                <div style="flex:1;"></div>
            </div>
        `;
        inventoryContainer.appendChild(inventoryRow);

        // Refresh Parsley to recognize new fields
        $('#listSpaceForm').parsley().refresh();
    }

    // Update current vacancy and validate against total seats
    function updateCurrentVacancy(spaceId) {
        const inventoryCounts = document.querySelectorAll(`#inventoryContainer_${spaceId} input[name^="inventory_count_${spaceId}"]`);
        const totalSeatsField = document.querySelector(`input[name="total_seats[]"][aria-label="Total Seats"]`);
        const currentVacancyField = document.getElementById(`current_vacancy_${spaceId}`);
        const totalSeats = parseInt(totalSeatsField.value) || 0;
        let totalVacancy = 0;

        // Sum up all inventory counts
        inventoryCounts.forEach(input => {
            totalVacancy += parseInt(input.value) || 0;
        });

        // Update the current vacancy field
        currentVacancyField.value = totalVacancy;

        // Validation: Ensure totalVacancy <= totalSeats
        const errorContainer = document.getElementById(`vacancyError_${spaceId}`);
        if (totalVacancy > totalSeats) {
            // Show error if the current vacancy exceeds total seats
            errorContainer.textContent = "Current vacancy cannot exceed total seats.";
            currentVacancyField.setCustomValidity("Invalid current vacancy.");
            // Show styled alert box
            showAlert("Error: Current vacancy cannot exceed total seats.");
        } else {
            // Clear the error if validation passes
            errorContainer.textContent = "";
            currentVacancyField.setCustomValidity("");
        }
    }

    function showAlert(message) {
        // Create the alert box
        const alertBox = document.createElement("div");
        alertBox.className = "alert alert-danger text-center fw-bold";
        alertBox.style.position = "fixed";
        alertBox.style.top = "20px";
        alertBox.style.left = "50%";
        alertBox.style.transform = "translateX(-50%)";
        alertBox.style.zIndex = "1050";
        alertBox.style.width = "50%";
        
        // Add the message to the alert box
        alertBox.innerHTML = `
            <span>${message}</span>
            <button type="button" class="btn-close" aria-label="Close"></button>
        `;

        // Append to the body
        document.body.appendChild(alertBox);

        // Add click event to the close button
        const closeButton = alertBox.querySelector(".btn-close");
        closeButton.addEventListener("click", () => {
            alertBox.remove();
        });
    }

    // Function to handle dynamic change for price input
    function handlePriceChange(selectElement, spaceId, inventoryCount) {
        const selectedValue = selectElement.value;
        const priceInput = document.getElementById(`priceInput_${spaceId}_${inventoryCount}`);

        if (selectedValue === 'Conference rooms' || selectedValue === 'Discussion rooms' || selectedValue === 'Meeting rooms') {
            priceInput.placeholder = "Price per Hour";
            priceInput.setAttribute('data-parsley-required-message', 'Please enter the price per hour.');
            priceInput.setAttribute('aria-label', 'Price per Hour');
        } else {
            priceInput.placeholder = "Price per Seat";
            priceInput.setAttribute('data-parsley-required-message', 'Please enter the price per seat.');
            priceInput.setAttribute('aria-label', 'Price per Seat');
        }

        // Refresh Parsley validation after changes
        $('#listSpaceForm').parsley().refresh();
    }

    // Function to remove a coworking space section
    function removeSpaceDetails(button) {
        const spaceCard = button.closest('.card');
        spaceCard.remove();

        // Refresh Parsley to exclude removed fields
        $('#listSpaceForm').parsley().refresh();
    }

    // Function to remove an inventory item
    function removeInventory(button) {
        const inventoryRow = button.closest('.inventory-item');
        inventoryRow.remove();

        // Refresh Parsley to exclude removed fields
        $('#listSpaceForm').parsley().refresh();
    }

    // Function to preview uploaded images
    function previewImages(event, spaceId) {
        const imagePreviewContainer = document.getElementById(`imagePreview_${spaceId}`);
        imagePreviewContainer.innerHTML = '';
        const files = event.target.files;

        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add('preview-img-container');
                imgContainer.innerHTML = `
                    <img src="${e.target.result}" class="preview-img" data-bs-toggle="modal" data-bs-target="#imageModal_${spaceId}_${index}" alt="Image Preview">
                    <button type="button" class="delete-button" onclick="removeImage(${index}, ${spaceId})" title="Remove this image">&times;</button>
                `;

                // Append the image container to the preview
                imagePreviewContainer.appendChild(imgContainer);

                // Create the modal for magnification
                const modal = document.createElement('div');
                modal.classList.add('modal', 'fade');
                modal.id = `imageModal_${spaceId}_${index}`;
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-labelledby', `imageModalLabel_${spaceId}_${index}`);
                modal.setAttribute('aria-hidden', 'true');
                modal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="imageModalLabel_${spaceId}_${index}">Image Preview</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <img src="${e.target.result}" class="img-fluid" alt="Full Image">
                            </div>
                        </div>
                    </div>
                `;

                // Append the modal to the body
                document.body.appendChild(modal);
            };
            reader.readAsDataURL(file);
        });
    }

    // Function to remove image previews
    function removeImage(index, spaceId) {
        const imagePreviewContainer = document.getElementById(`imagePreview_${spaceId}`);
        const imgToRemove = imagePreviewContainer.querySelectorAll('.preview-img-container')[index];
        if (imgToRemove) {
            imgToRemove.remove();
        }

        // Remove the corresponding modal
        const modalToRemove = document.getElementById(`imageModal_${spaceId}_${index}`);
        if (modalToRemove) {
            modalToRemove.remove();
        }
    }

    // Function to remove existing images (when editing)
    function removeExistingImage(spaceId, index) {
        // Implement functionality to mark the image for deletion
        // For simplicity, we'll just remove it from the preview
        const imagePreviewContainer = document.getElementById(`imagePreview_${spaceId}`);
        const imgContainers = imagePreviewContainer.querySelectorAll('.preview-img-container');
        if (imgContainers[index]) {
            imgContainers[index].remove();
        }

        // Remove the corresponding modal
        const modalToRemove = document.getElementById(`existingImageModal_${spaceId}_${index}`);
        if (modalToRemove) {
            modalToRemove.remove();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Parsley for the form
        $('#listSpaceForm').parsley();

        // Initialize form with existing data if editing
        if (spaceData) {
            addSpaceDetails(spaceData);
        } else {
            // Add one coworking space section when the page loads
            addSpaceDetails();
        }

        // Optional: Customize Parsley error placement
        $('#listSpaceForm').parsley().on('field:error', function() {
            // Custom behavior on error if needed
        }).on('field:success', function() {
            // Custom behavior on success if needed
        }).on('form:error', function() {
            // Scroll to the first error field
            const firstError = document.querySelector('.parsley-error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });

        // Handle form submission to show loading spinner and prevent multiple submissions
        document.getElementById('listSpaceForm').addEventListener('submit', function(e) {
            const spaceDetailsContainer = document.getElementById('spaceDetailsContainer');

            // Prevent form submission if no coworking space section is present
            if (spaceDetailsContainer.children.length === 0) {
                e.preventDefault();
                alert("You must add at least one coworking space.");
                return;
            }

            // Continue if Parsley validation passes
            var form = $(this);
            form.parsley().validate();

            if (form.parsley().isValid()) {
                // Show the loading spinner
                document.getElementById('loadingSpinner').style.display = 'block';
                // Disable the submit button to prevent multiple submissions
                document.getElementById('submitButton').disabled = true;
            } else {
                // Prevent form submission if validation fails
                e.preventDefault();
            }
        });
    });

    // Function to handle form submission
    document.addEventListener('DOMContentLoaded', function() {
        $('#listSpaceForm').parsley();

        document.getElementById('listSpaceForm').addEventListener('submit', function(e) {
            const totalSeatsFields = document.querySelectorAll(`input[name="total_seats[]"]`);

            // Validate current vacancy for all spaces
            totalSeatsFields.forEach((field, index) => {
                updateCurrentVacancy(index + 1);

                // Check if any current vacancy is invalid
                const currentVacancyField = document.getElementById(`current_vacancy_${index + 1}`);
                if (!currentVacancyField.checkValidity()) {
                    e.preventDefault();
                    currentVacancyField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        });
    });

    // Fetch unique locations (cities) from the database and make dropdown scrollable
function fetchLocations() {
    console.log('Fetching locations...');
    fetch('/get_locations', {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        console.log('Locations data:', data); // Debugging info
        const locationDropdown = document.getElementById(`location_${spaceCount}`);
        locationDropdown.innerHTML = '<option selected disabled>Select Location</option>';
        
        // Sort locations and capitalize the first letter
        const sortedLocations = data.locations
            .map(location => location.charAt(0).toUpperCase() + location.slice(1))
            .sort();

        sortedLocations.forEach(function(location) {
            let option = document.createElement("option");
            option.value = location;
            option.text = location;
            locationDropdown.appendChild(option);
        });

        // Add "Other" option
        let otherOption = document.createElement("option");
        otherOption.value = "Other";
        otherOption.text = "Other";
        locationDropdown.appendChild(otherOption);

        // Adjust size of the dropdown on focus
        locationDropdown.addEventListener('focus', function () {
            locationDropdown.size = 5;
        });

        locationDropdown.addEventListener('change', function () {
            if (locationDropdown.value === "Other") {
                showCustomInput('location', spaceCount);
            } else {
                closeDropdown(`location_${spaceCount}`);
                fetchMicromarkets(); // Fetch micromarkets when location changes
            }
        });
    })
    .catch(error => {
        console.error('Error fetching locations:', error);
    });
}

// Fetch unique micromarkets for the selected city
function fetchMicromarkets() {
    const cityDropdown = document.getElementById(`location_${spaceCount}`);
    const selectedCity = cityDropdown.value; 
    console.log('Fetching micromarkets for city:', selectedCity);

    fetch(`/get_micromarkets?city=${selectedCity}`, {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        console.log('Micromarkets data:', data); // Debugging info
        // Select the micromarket dropdown dynamically for the specific coworking space card
        const micromarketDropdown = cityDropdown.closest('.form-group').querySelector('select[name="micromarket[]"]');

        if (micromarketDropdown) {
                // Clear and populate the micromarket dropdown
                micromarketDropdown.innerHTML = '<option selected disabled>Select Micromarket</option>';

                // Sort micromarkets and capitalize the first letter
            const sortedMicromarkets = data.micromarkets
                .map(micromarket => micromarket.charAt(0).toUpperCase() + micromarket.slice(1))
                .sort();

            sortedMicromarkets.forEach(function(micromarket) {
                let option = document.createElement("option");
                option.value = micromarket;
                option.text = micromarket;
                micromarketDropdown.appendChild(option);
            });

                // Add "Other" option
                let otherOption = document.createElement("option");
                otherOption.value = "Other";
                otherOption.text = "Other";
                micromarketDropdown.appendChild(otherOption);

                // Ensure the dropdown is clickable
                micromarketDropdown.disabled = false;
                micromarketDropdown.addEventListener('focus', function () {
                    micromarketDropdown.size = 5; // Expand the dropdown on focus
                });

                micromarketDropdown.addEventListener('change', function () {
                if (micromarketDropdown.value === "Other") {
                    showCustomInput('micromarket', spaceCount);
                } else {
                    micromarketDropdown.size = 1; // Close the dropdown on change
                }
            });
            }
        })
        .catch(error => {
            console.error('Error fetching micromarkets:', error);
        });
}

// Show custom input field when "Other" is selected
// function showCustomInput(type, spaceCount) {
//     const dropdown = document.getElementById(`${type}_${spaceCount}`);
//     const customInputId = `${type}_custom_input_${spaceCount}`; // Unique ID for the custom input field
//     const existingInput = document.getElementById(customInputId);

//     // Check if the custom input field already exists
//     if (!existingInput) {
//         const container = document.createElement("div");
//         container.classList.add("custom-input-container");
//         container.setAttribute("id", customInputId); // Set unique ID for the input container

//         container.innerHTML = `
//             <input type="text" class="form-control mt-2" placeholder="Enter ${type}" name="${type}_custom_${spaceCount}" 
//                 required data-parsley-required-message="Please enter your ${type}." 
//                 data-parsley-trigger="change" aria-label="Custom ${type}" />
//         `;

//         dropdown.parentNode.appendChild(container);

//         // Disable dropdown when custom input is active
//         dropdown.disabled = true;
//     }
// }

// Function to show a custom input field when "Other" is selected
function showCustomInput(type, spaceId) {
    const dropdown = document.getElementById(`${type}_${spaceId}`);
    const customInputId = `${type}_custom_${spaceId}`;
    let customInputContainer = document.getElementById(customInputId);

    if (!customInputContainer) {
        customInputContainer = document.createElement("div");
        customInputContainer.id = customInputId;
        customInputContainer.classList.add("mt-2");

        customInputContainer.innerHTML = `
            <input type="text" class="form-control" placeholder="Enter ${type}" name="${type}_custom_1[]" 
                required data-parsley-required-message="Please enter your ${type}." 
                data-parsley-trigger="change" aria-label="Custom ${type}">
        `;

        dropdown.parentNode.appendChild(customInputContainer);
    }
}

// Function to hide custom input and re-enable dropdown
function hideCustomInput(type, spaceId) {
    const customInputId = `${type}_custom_${spaceId}`;
    const customInputContainer = document.getElementById(customInputId);

    if (customInputContainer) {
        customInputContainer.remove();
    }

}

// Handle dropdown changes for city and micromarket
function handleDropdownChange(type, spaceId) {
        const dropdown = document.getElementById(`${type}_${spaceId}`);
        dropdown.addEventListener('change', function () {
            if (dropdown.value === "Other") {
                showCustomInput(type, spaceId);
            } else {
                hideCustomInput(type, spaceId);
            }
        });
    }



// Close dropdown after selection
function closeDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    dropdown.size = 1; // Close dropdown when an option is selected
}

// Handle dropdown close when clicked outside
document.addEventListener('DOMContentLoaded', function () {
        // Initialize event listeners for dropdown changes
        document.querySelectorAll('[id^="location_"], [id^="micromarket_"]').forEach(dropdown => {
            const type = dropdown.id.startsWith('location') ? 'location' : 'micromarket';
            const spaceId = dropdown.id.split('_')[1];
            handleDropdownChange(type, spaceId);
        });
    });

document.addEventListener('DOMContentLoaded', function () {
    addSpaceDetails(); // Add one coworking space by default
        $('#listSpaceForm').parsley();
    });
</script>

</body>
</html>